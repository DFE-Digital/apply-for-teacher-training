{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceEnvironmentName": {
            "type": "string",
            "metadata": {
                "description": "The environment of the resource."
            }
        },
        "serviceName": {
            "type": "string",
            "metadata": {
                "description": "The abbreviation of the service name to be used when naming a resource."
            }
        },
        "dockerHubUsername": {
            "type": "string",
            "metadata": {
                "description": "the username associated with the dockerhub account"
            }
        },
        "containerImageReference": {
            "type": "string",
            "metadata": {
                "description": "The container image to pull from the server. Should be in image:tag format."
            }
        },
        "railsEnv": {
            "type": "string",
            "defaultValue": "production",
            "metadata": {
                "description": "Environment for the rails app."
            }
        },
        "databaseName": {
            "type": "string",
            "metadata": {
                "description": "The name of the postgres database"
            }
        },
        "databaseUsername": {
            "type": "string",
            "metadata": {
                "description": "The username used to connect to the database."
            }
        },
        "databasePassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password used to connect to the database."
            }
        },
        "databaseStorageAutoGrow": {
            "type": "string",
            "metadata": {
                "description": "Used to enable or disable autogrow on the database storage."
            }
        },
        "databaseBackupRetentionDays": {
            "type": "int",
            "metadata": {
                "description": "Used to configure the number of days the database backups will be retained for."
            }
        },
        "securityAlertEmail": {
            "type": "string",
            "metadata": {
                "description": "Email address for psql security alerts"
            }
        },
        "secretKeyBase": {
            "type": "string",
            "metadata": {
                "description": "Secret key base for rails"
            }
        },
        "containerStartTimeLimit": {
            "type": "string",
            "metadata": {
                "description": "Time limit in seconds, up to 1800s, that the appService will wait for the container to start."
            }
        },
        "warmupPingPath": {
            "type": "string",
            "metadata": {
                "description": "The path to ping during webapp warmup process, prior to slot swap."
            }
        },
        "warmupPingStatus": {
            "type": "string",
            "metadata": {
                "description": "The permitted status codes to indicate a successful app warmup."
            }
        },
        "govukNotifyAPIKey": {
            "type": "string",
            "metadata": {
                "description": "GOV.UK Notify service API key."
            }
        },
        "basicAuthUsername": {
            "type": "string",
            "metadata": {
                "description": "Basic Auth Username for the entire site except API routes"
            }
        },
        "basicAuthPassword": {
            "type": "string",
            "metadata": {
                "description": "Basic Auth Password for the entire site except API routes"
            }
        },
        "supportUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the support section of the site"
            }
        },
        "supportPassword": {
            "type": "string",
            "metadata": {
                "description": "Password for the support section of the site"
            }
        },
        "keyVaultName": {
            "type": "string",
            "metadata": {
                "description": "The name of the key vault."
            }
        },
        "keyVaultResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "The resource group for the key vault."
            }
        },
        "authorisedHosts": {
            "type": "string",
            "metadata": {
                "description": "Comma seperated list of FQDNs authorised to access the app."
            }
        },
        "customHostName": {
            "type": "string",
            "metadata": {
                "description": "The top level common domain for the service, e.g. apply-for-teacher-training.education.gov.uk."
            }
        },
        "railsServeStaticFiles": {
            "type": "string",
            "defaultValue": "true",
            "metadata": {
                "description": "Serve static files."
            }
        },
        "sentryDSN": {
            "type": "string",
            "metadata": {
                "description": "Sentry client key."
            }
        },
        "logstashEnable": {
            "type": "string",
            "metadata": {
                "description": "Set this to 'true' to log to STDOUT in logstash format."
            }
        },
        "logstashRemote": {
            "type": "string",
            "metadata": {
                "description": "Set this to 'true' to ship logstash logs to remote server. Requires LOGSTASH_ENABLED == 'true'."
            }
        },
        "logstashHost": {
            "type": "string",
            "metadata": {
                "description": "Logstash/Logit Host to send logs to."
            }
        },
        "logstashPort": {
            "type": "string",
            "metadata": {
                "description": "Logstash/Logit Port to send logs to."
            }
        },
        "logstashSsl": {
            "type": "string",
            "metadata": {
                "description": "Set this to 'true' to use SSL when shipping logs."
            }
        },
        "findBaseUrl": {
            "type": "string",
            "metadata": {
                "description": "The base URL to manage-courses-backend, Find's backend."
            }
        },
        "redisCacheName": {
            "type": "string",
            "metadata": {
                "description": "Redis URL prefix name."
            }
        },
        "containerInstanceNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The name prefix for the background worker container instances."
            }
        },
        "disableBasicAuthForLandingPage": {
            "type": "string",
            "metadata": {
                "description": "Should basic auth be disabled for the /candidate/apply landing page linked from Find?"
            }
        }
    },
    "variables": {
        "deploymentUrlBase": "https://raw.githubusercontent.com/DFE-Digital/bat-platform-building-blocks/master/templates/",
        "appServiceRuntimeStack": "[concat('DOCKER|', parameters('dockerHubUsername'), '/', parameters('containerImageReference'))]",
        "containerImageName": "[concat(parameters('dockerHubUsername'), '/', parameters('containerImageReference'))]",
        "resourceNamePrefix": "[toLower(concat('s106', parameters('resourceEnvironmentName'),'-', parameters('serviceName')))]",
        "appServiceName": "[concat(variables('resourceNamePrefix'), '-as')]",
        "appServicePlanName": "[concat(variables('resourceNamePrefix'), '-asp')]",
        "storageAccountName": "[replace(concat(variables('resourceNamePrefix'), 'str'), '-', '')]",
        "databaseServerName": "[concat(variables('resourceNamePrefix'), '-psql')]",
        "keyVaultCertificateName": "[replace(parameters('customHostName'), '.', '-')]",
        "rubyAuthHosts": "[if(greater(length(parameters('customHostName')), 0), concat(parameters('authorisedHosts'), ',', parameters('customHostName')), parameters('authorisedHosts'))]"
    },
    "resources": [
        {
            "name": "storage-account",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'storage-account.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    }
                }
            }
        },
	{
            "name": "redis-cache",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'redis.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "redisCacheName": {
                        "value": "[parameters('redisCacheName')]"
                    },
                    "enableNonSslPort": {
                        "value": true
                    }
                }
            }
        },
        {
            "name": "app-service-plan",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'app-service-plan.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServicePlanName": {
                        "value": "[variables('appServicePlanName')]"
                    },
                    "appServicePlanTier": {
                        "value": "Standard"
                    },
                    "appServicePlanSize": {
                        "value": "2"
                    }
                }
            }
        },
        {
            "name": "app-service-certificate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[greater(length(parameters('customHostName')), 0)]",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'app-service-certificate.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "keyVaultCertificateName": {
                        "value": "[variables('keyVaultCertificateName')]"
                    },
                    "keyVaultName": {
                        "value": "[parameters('keyVaultName')]"
                    },
                    "keyVaultResourceGroup": {
                        "value": "[parameters('keyVaultResourceGroup')]"
                    }
                }
            }
        },
        {
            "name": "app-service",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'app-service-linux.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[variables('appServiceName')]"
                    },
                    "appServicePlanResourceGroup": {
                        "value": "[resourceGroup().name]"
                    },
                    "appServicePlanName": {
                        "value": "[variables('appServicePlanName')]"
                    },
                    "customHostName": {
                        "value": "[parameters('customHostName')]"
                    },
                    "certificateThumbprint": {
                        "value": "[if(greater(length(parameters('customHostName')), 0), reference('app-service-certificate', '2018-11-01').outputs.certificateThumbprint.value, '')]"
                    },
                    "runtimeStack": {
                        "value": "[variables('appServiceRuntimeStack')]"
                    },
                    "appServiceAppSettings": {
                        "value": [
                            {
                                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                                "value": "[reference('app-insights').outputs.instrumentationKey.value]"
                            },
                            {
                                "name": "RAILS_ENV",
                                "value": "[parameters('railsEnv')]"
                            },
                            {
                                "name": "DB_HOSTNAME",
                                "value": "[reference('postgresql-server').outputs.fullyQualifiedDomainName.value]"
                            },
                            {
                                "name": "DB_USERNAME",
                                "value": "[concat(parameters('databaseUsername'), '@', variables('databaseServerName'))]"
                            },
                            {
                                "name": "DB_PASSWORD",
                                "value": "[parameters('databasePassword')]"
                            },
                            {
                                "name": "DB_DATABASE",
                                "value": "[parameters('databaseName')]"
                            },
                            {
                                "name": "SECRET_KEY_BASE",
                                "value": "[parameters('secretKeyBase')]"
                            },
                            {
                                "name": "WEBSITES_CONTAINER_START_TIME_LIMIT",
                                "value": "[parameters('containerStartTimeLimit')]"
                            },
                            {
                                "name": "WEBSITE_SWAP_WARMUP_PING_PATH",
                                "value": "[parameters('warmupPingPath')]"
                            },
                            {
                                "name": "WEBSITE_SWAP_WARMUP_PING_STATUSES",
                                "value": "[parameters('warmupPingStatus')]"
                            },
                            {
                                "name": "WEBSITE_SLOT_POLL_WORKER_FOR_CHANGE_NOTIFICATION",
                                "value": "0"
                            },
                            {
                                "name": "RAILS_SERVE_STATIC_FILES",
                                "value": "[parameters('railsServeStaticFiles')]"
                            },
                            {
                                "name": "GOVUK_NOTIFY_API_KEY",
                                "value": "[parameters('govukNotifyAPIKey')]"
                            },
                            {
                                "name": "BASIC_AUTH_USERNAME",
                                "value": "[parameters('basicAuthUsername')]"
                            },
                            {
                                "name": "BASIC_AUTH_PASSWORD",
                                "value": "[parameters('basicAuthPassword')]"
                            },
                            {
                                "name": "SUPPORT_USERNAME",
                                "value": "[parameters('supportUsername')]"
                            },
                            {
                                "name": "SUPPORT_PASSWORD",
                                "value": "[parameters('supportPassword')]"
                            },
                            {
                                "name": "AUTHORISED_HOSTS",
                                "value": "[variables('rubyAuthHosts')]"
                            },
                            {
                                "name": "CUSTOM_HOSTNAME",
                                "value": "[parameters('customHostName')]"
                            },
                            {
                                "name": "SENTRY_DSN",
                                "value": "[parameters('sentryDSN')]"
                            },
                            {
                                "name": "LOGSTASH_ENABLE",
                                "value": "[parameters('logstashEnable')]"
                            },
                            {
                                "name": "LOGSTASH_REMOTE",
                                "value": "[parameters('logstashRemote')]"
                            },
                            {
                                "name": "LOGSTASH_HOST",
                                "value": "[parameters('logstashHost')]"
                            },
                            {
                                "name": "LOGSTASH_PORT",
                                "value": "[parameters('logstashPort')]"
                            },
                            {
                                "name": "LOGSTASH_SSL",
                                "value": "[parameters('logstashSsl')]"
                            },
                            {
                                "name": "FIND_BASE_URL",
                                "value": "[parameters('findBaseUrl')]"
                            },
                            {
                                "name": "DISABLE_BASIC_AUTH_FOR_LANDING_PAGE",
                                "value": "[parameters('disableBasicAuthForLandingPage')]"
                            }
                        ]
                    }
                }
            },
            "dependsOn": [
                "app-service-plan",
                "app-service-certificate",
                "redis-cache",
		"postgresql-database"
            ]
        },
        {
            "name": "container-instances-worker",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'container-instances.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "containerInstanceName": {
                        "value": "[concat(parameters('containerInstanceNamePrefix'), '-wkr')]"
                    },
                    "containerName": {
                        "value": "[concat(parameters('containerInstanceNamePrefix'), '-wkr')]"
                    },
                    "imageName": {
                        "value": "[variables('containerImageName')]"
                    },
		    "command": {
		        "value": ["/bin/sh",  "-c", "bundle exec sidekiq -c 5"]
		    },
                    "environmentVariables": {
                        "value": [
                            {
                                "name": "RAILS_ENV",
                                "value": "[parameters('railsEnv')]"
                            },
                            {
                                "name": "DB_DATABASE",
                                "value": "[parameters('databaseName')]"
                            },
                            {
                                "name": "DB_HOSTNAME",
                                "value": "[reference('postgresql-server').outputs.fullyQualifiedDomainName.value]"
                            },
                            {
                                "name": "DB_PASSWORD",
                                "secureValue": "[parameters('databasePassword')]"
                            },
                            {
                                "name": "DB_USERNAME",
                                "value": "[concat(parameters('databaseUsername'), '@', variables('databaseServerName'))]"
                            },
                            {
                                "name": "AUTHORISED_HOSTS",
                                "value": "[variables('rubyAuthHosts')]"
                            },
                            {
                                "name": "SECRET_KEY_BASE",
                                "secureValue": "[parameters('secretKeyBase')]"
                            },
                            {
                                "name": "SENTRY_DSN",
                                "value": "[parameters('sentryDSN')]"
                            },
                            {
                                "name": "SUPPORT_USERNAME",
                                "value": "[parameters('supportUsername')]"
                            },
                            {
                                "name": "SUPPORT_PASSWORD",
                                "secureValue": "[parameters('supportPassword')]"
                            },
                            {
                                "name": "GOVUK_NOTIFY_API_KEY",
                                "secureValue": "[parameters('govukNotifyAPIKey')]"
                            },
                            {
                                "name": "LOGSTASH_ENABLE",
                                "value": "[parameters('logstashEnable')]"
                            },
                            {
                                "name": "LOGSTASH_REMOTE",
                                "value": "[parameters('logstashRemote')]"
                            },
                            {
                                "name": "LOGSTASH_HOST",
                                "value": "[parameters('logstashHost')]"
                            },
                            {
                                "name": "LOGSTASH_PORT",
                                "value": "[parameters('logstashPort')]"
                            },
                            {
                                "name": "LOGSTASH_SSL",
                                "value": "[parameters('logstashSsl')]"
                            },
                            {
                                "name": "FIND_BASE_URL",
                                "value": "[parameters('findBaseUrl')]"
                            },
                            {
                                "name": "SERVICE_TYPE",
                                "value": "[concat(parameters('containerInstanceNamePrefix'), '-wkr')]"
                            },
                            {
                                "name": "REDIS_URL",
                                "secureValue": "[concat('rediss://:', reference('redis-cache').outputs.PrimaryKey.value, '@', parameters('redisCacheName'), '.redis.cache.windows.net:6380')]"
                            }
                        ]
                    }
                }
            },
            "dependsOn": [
                "redis-cache",
		"postgresql-database"
            ]
        },
        {
            "name": "container-instances-clock",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'container-instances.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "containerInstanceName": {
                        "value": "[concat(parameters('containerInstanceNamePrefix'), '-clk')]"
                    },
                    "containerName": {
                        "value": "[concat(parameters('containerInstanceNamePrefix'), '-clk')]"
                    },
                    "imageName": {
                        "value": "[variables('containerImageName')]"
                    },
		    "command": {
		        "value": ["/bin/sh", "-c", "bundle exec clockwork config/clock.rb"]
		    },
                    "environmentVariables": {
                        "value": [
                            {
                                "name": "RAILS_ENV",
                                "value": "[parameters('railsEnv')]"
                            },
                            {
                                "name": "DB_DATABASE",
                                "value": "[parameters('databaseName')]"
                            },
                            {
                                "name": "DB_HOSTNAME",
                                "value": "[reference('postgresql-server').outputs.fullyQualifiedDomainName.value]"
                            },
                            {
                                "name": "DB_PASSWORD",
                                "secureValue": "[parameters('databasePassword')]"
                            },
                            {
                                "name": "DB_USERNAME",
                                "value": "[concat(parameters('databaseUsername'), '@', variables('databaseServerName'))]"
                            },
                            {
                                "name": "AUTHORISED_HOSTS",
                                "value": "[variables('rubyAuthHosts')]"
                            },
                            {
                                "name": "SECRET_KEY_BASE",
                                "secureValue": "[parameters('secretKeyBase')]"
                            },
                            {
                                "name": "SENTRY_DSN",
                                "value": "[parameters('sentryDSN')]"
                            },
                            {
                                "name": "SUPPORT_USERNAME",
                                "value": "[parameters('supportUsername')]"
                            },
                            {
                                "name": "SUPPORT_PASSWORD",
                                "secureValue": "[parameters('supportPassword')]"
                            },
                            {
                                "name": "GOVUK_NOTIFY_API_KEY",
                                "secureValue": "[parameters('govukNotifyAPIKey')]"
                            },
                            {
                                "name": "LOGSTASH_ENABLE",
                                "value": "[parameters('logstashEnable')]"
                            },
                            {
                                "name": "LOGSTASH_REMOTE",
                                "value": "[parameters('logstashRemote')]"
                            },
                            {
                                "name": "LOGSTASH_HOST",
                                "value": "[parameters('logstashHost')]"
                            },
                            {
                                "name": "LOGSTASH_PORT",
                                "value": "[parameters('logstashPort')]"
                            },
                            {
                                "name": "LOGSTASH_SSL",
                                "value": "[parameters('logstashSsl')]"
                            },
                            {
                                "name": "FIND_BASE_URL",
                                "value": "[parameters('findBaseUrl')]"
                            },
                            {
                                "name": "SERVICE_TYPE",
                                "value": "[concat(parameters('containerInstanceNamePrefix'), '-clk')]"
                            },
                            {
                                "name": "REDIS_URL",
                                "secureValue": "[concat('rediss://:', reference('redis-cache').outputs.PrimaryKey.value, '@', parameters('redisCacheName'), '.redis.cache.windows.net:6380')]"
                            }
                        ]
                    }
                }
            },
            "dependsOn": [
                "redis-cache",
		"postgresql-database"
            ]
        },
        {
            "name": "app-service-logs",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'app-service-logs.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[variables('appServiceName')]"
                    },
                    "httpLoggingEnabled": {
                        "value": true
                    },
                    "detailedErrorLoggingEnabled": {
                        "value": true
                    },
                    "applicationLogsFileSystem": {
                        "value": "Verbose"
                    }
                }
            },
            "dependsOn": [
                "app-service"
            ]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "app-insights",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'), 'application-insights.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appInsightsName": {
                        "value": "[variables('appServiceName')]"
                    },
                    "attachedService": {
                        "value": "[variables('appServiceName')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "postgresql-server",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'postgresql-server.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "postgresServerName": {
                        "value": "[variables('databaseServerName')]"
                    },
                    "postgresAdminLogin": {
                        "value": "[parameters('databaseUsername')]"
                    },
                    "postgresAdminPassword": {
                        "value": "[parameters('databasePassword')]"
                    },
                    "securityAlertEmailAddress": {
                        "value": "[parameters('securityAlertEmail')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "storageAutoGrow": {
                        "value": "[parameters('databaseStorageAutoGrow')]"
                    },
                    "backupRetentionDays": {
                        "value": "[parameters('databaseBackupRetentionDays')]"
                    }
                }
            },
            "dependsOn": [
                "storage-account"
            ]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "postgresql-database",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'postgresql-database.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "serverName": {
                        "value": "[variables('databaseServerName')]"
                    },
                    "databaseName": {
                        "value": "[parameters('databaseName')]"
                    }
                }
            },
            "dependsOn": [
                "postgresql-server"
            ]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "postgresql-server-firewall-rules",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('deploymentUrlBase'),'postgresql-server-firewall-rules.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "firewallRuleNamePrefix": {
                        "value": "AZURE_IP-"
                    },
                    "ipAddresses": {
                        "value": "[reference('app-service').outputs.possibleOutboundIpAddresses.value]"
                    },
                    "serverName": {
                        "value": "[variables('databaseServerName')]"
                    }
                }
            },
            "dependsOn": [
                "postgresql-server"
            ]
        }
    ],
    "outputs": {
        "AppServiceName": {
            "type": "string",
            "value": "[variables('appServiceName')]"
        }
    }
}
