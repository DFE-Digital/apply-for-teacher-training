<% if @application_choice.rejected_by_default? %>
  <% content_for :before_content, govuk_back_link_to(provider_interface_application_choice_path(@application_choice)) %>
<% else %>
  <% content_for :before_content, govuk_back_link_to(new_provider_interface_application_choice_decision_path(@application_choice)) %>
<% end -%>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= form_with model: @wizard, url: provider_interface_rejections_path do |f| %>

      <%= f.govuk_error_summary %>

      <% content_for(:fieldset_legend) do %>
        <h1 class="govuk-heading-l">
          <% if rbd_application_with_no_feedback? %>
            <span class="govuk-caption-l">Give feedback - <%= @application_choice.application_form.full_name %></span>
            Reasons the application was rejected
          <% else %>
            Tell <%= @application_choice.application_form.full_name %> why you are rejecting their application
          <% end %>
        </h1>
      <% end %>

      <%= f.govuk_check_boxes_fieldset :selected_reasons, legend: -> { content_for(:fieldset_legend) }, form_group: { classes: 'govuk-!-margin-bottom-2' } do %>
        <% @wizard.class.selectable_reasons.each do |reason| %>

          <% if reason.id == 'no_maths_gcse' %>
            <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Does not meet initial teacher training criteria</h2>
          <% elsif reason.id == 'degree_does_not_match' %>
            <h2 class="govuk-heading-s govuk-!-margin-top-6 govuk-!-margin-bottom-2">Does not meet course requirements</h2>
          <% elsif reason.id == 'could_not_contact' %>
            <h2 class="govuk-heading-s govuk-!-margin-top-6 govuk-!-margin-bottom-2">Other reasons</h2>
          <% end %>

          <% if reason.id == 'course_full' && @application_choice.course_option.course.open_on_apply? %>
            <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-padding-top-2 govuk-!-padding-bottom-2 govuk-!-padding-left-3">
              Is the course full? <%= govuk_link_to "Close it on Publish", "https://www.publish-teacher-training-courses.service.gov.uk/publish/organisations/#{@application_choice.course_option.course.provider.code}/#{@application_choice.application_form.recruitment_cycle_year}/courses/#{@application_choice.course_option.course.code}" %> before using ‘Course full’ as a rejection reason
            </div>
          <% else %>

            <%= f.govuk_check_box :selected_reasons, reason.id, label: { text: reason.label }, link_errors: true do %>
              <% if reason.details.present? %>
                <%= f.govuk_text_area reason.details.id.to_sym,
                    label: { text: reason.details.label, size: 's' }, max_words: RejectionReasons::Details::MAX_WORDS %>
              <% elsif reason.reasons&.any? %>
                <%= f.govuk_check_boxes_fieldset reason.selected_reasons_attr_name, legend: { text: 'Reasons', size: 's' } do %>
                  <% reason.reasons.each do |nested_reason| %>
                    <%= f.govuk_check_box reason.selected_reasons_attr_name,
                      nested_reason.id,
                      label: { text: nested_reason.label },
                      link_errors: true do %>
                      <% if nested_reason.details.present? %>
                        <%= f.govuk_text_area nested_reason.details.id.to_sym,
                          label: {
                            text: nested_reason.details.label,
                            size: 's',
                          },
                          max_words: RejectionReasons::Details::MAX_WORDS %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <%= f.govuk_submit t('continue') %>
    <% end %>

    <p class="govuk-body"><%= govuk_link_to t('cancel'), provider_interface_application_choice_path(@application_choice), no_visited_state: true %></p>
  </div>
</div>
