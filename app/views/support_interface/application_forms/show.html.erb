<% content_for :browser_title, title_with_success_prefix("Application ##{@application_form.id}", flash[:success].present?) %>
<% content_for :title do %>
  <span class="govuk-caption-xl">Application #<%= @application_form.id %></span>
  <%= @application_form.candidate.email_address %>
<% end %>

<% content_for :before_content do %>
  <div class="govuk-breadcrumbs">
    <ol class="govuk-breadcrumbs__list">
      <li class="govuk-breadcrumbs__list-item">
        <%= link_to 'Applications', support_interface_applications_path, class: 'govuk-breadcrumbs__link' %>
      </li>
      <li class="govuk-breadcrumbs__list-item" aria-current="page">
        <%= @application_form.candidate.email_address %>
      </li>
    </ol>
  </div>
<% end %>

<%= render SupportInterface::ApplicationSummaryComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Personal details</h2>

<%= render PersonalDetailsComponent.new(application_form: @application_form) %>

<% unless HostingEnvironment.production? %>
  <%= button_to 'Sign in as this candidate', support_interface_impersonate_candidate_path(@application_form.candidate), class: 'govuk-button' %>
<% end %>

<% if @application_form.candidate.hide_in_reporting? %>
  <%= button_to 'Include this candidate in service performance data', support_interface_show_candidate_path(@application_form.candidate, from_application_form_id: @application_form.id), class: 'govuk-button govuk-button--secondary' %>
<% else %>
  <%= button_to 'Exclude this candidate from service performance data', support_interface_hide_candidate_path(@application_form.candidate, from_application_form_id: @application_form.id), class: 'govuk-button govuk-button--secondary' %>
<% end %>

<% if @application_form.application_choices.any? %>
  <h2 class="govuk-heading-l govuk-!-margin-top-8">Course choices</h2>
  <% @application_form.application_choices.includes(:course, :provider, :site, :offered_course_option).each do |application_choice| %>
    <% rows = [
      { key: 'Course', value: govuk_link_to(application_choice.offered_course.name_and_code, support_interface_course_path(application_choice.offered_course)) },
      { key: 'Provider', value: govuk_link_to(application_choice.offered_course.provider.name_and_code, support_interface_provider_path(application_choice.offered_course.provider)) },
      { key: 'Location', value: application_choice.offered_option.site.name_and_code },
      { key: 'Status', value: render(SupportInterface::ApplicationStatusTagComponent.new(application_choice: application_choice)) },
    ] %>
    <% rows << { key: 'Reason for rejection', value: application_choice.rejection_reason } if application_choice.rejection_reason.present? %>
    <% rows << { key: 'Sent to provider at', value: application_choice.sent_to_provider_at.to_s(:govuk_date_and_time) } if application_choice.sent_to_provider_at %>
    <% rows << { key: 'Reject by default at', value: application_choice.reject_by_default_at.to_s(:govuk_date_and_time) } if application_choice.reject_by_default_at %>
    <% rows << { key: 'Decline by default at', value: application_choice.decline_by_default_at.to_s(:govuk_date_and_time) } if application_choice.decline_by_default_at %>

    <%= render SummaryCardComponent.new(rows: rows) do %>
      <%= render SummaryCardHeaderComponent.new(title: application_choice.offered_course.name_and_code) %>
    <% end %>
  <% end %>
<% end %>

<% if @application_form.application_choices.any?(&:awaiting_references?) %>
  <%= govuk_button_link_to 'Add course', support_interface_add_course_to_application_path(@application_form) %>
<% end %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">References</h2>

<% reference_status = ReferenceStatus.new(@application_form) %>

<% if reference_status.still_more_references_needed? %>
  <p class="govuk-body">
    This candidate needs to provide <%= reference_status.number_of_references_that_currently_need_replacing %> new reference(s).
  </p>
<% end %>

<% if @application_form.application_references.any? %>
  <% @application_form.application_references.each_with_index do |reference, i| %>
    <%= render SupportInterface::ReferenceWithFeedbackComponent.new(reference: reference, title: "#{(i + 1).ordinalize} reference #{reference.replacement? ? '(replacement)' : nil}") %>
  <% end %>
<% end %>

<h2 class="govuk-heading-l govuk-!-margin-top-8" id="qualifications">Qualifications</h2>

<%= render QualificationsComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Work history</h2>

<%= render WorkHistoryReviewComponent.new(application_form: @application_form, editable: false, heading_level: 3) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Unpaid experience and volunteering</h2>

<%= render VolunteeringReviewComponent.new(application_form: @application_form, editable: false, heading_level: 3) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Language skills</h2>

<%= render LanguageSkillsComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Personal statement</h2>

<%= render PersonalStatementComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Criminal convictions and professional misconduct</h2>

<%= render SafeguardingIssuesComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Request feedback</h2>

<p class="govuk-body">Ask the candidate to fill out a survey.</p>

<%= govuk_button_link_to t('survey_emails.send.link'), support_interface_survey_emails_path(@application_form), class: 'govuk-button--secondary' %>
